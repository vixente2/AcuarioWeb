@using Newtonsoft.Json
@model AcuarioWebs.Controllers.DashboardViewModel

@{
    ViewData["Title"] = "Dashboard";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

<div class="container my-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h3">Dashboard</h1>
        <small class="text-muted">Última actualización: @DateTime.Now.ToString("dd/MM/yyyy HH:mm")</small>
    </div>

    <!-- MÉTRICAS -->
    <div class="row g-3 mb-4">
        <div class="col-sm-6 col-md-3">
            <div class="card shadow-sm p-3 text-center">
                <small>Total Usuarios</small>
                <h4>@Model.TotalUsuarios</h4>
            </div>
        </div>
        <div class="col-sm-6 col-md-3">
            <div class="card shadow-sm p-3 text-center">
                <small>Total Peces</small>
                <h4>@Model.TotalPeces</h4>
            </div>
        </div>
        <div class="col-sm-6 col-md-3">
            <div class="card shadow-sm p-3 text-center">
                <small>Atenciones (mes)</small>
                <h4>@Model.AtencionesEsteMes</h4>
            </div>
        </div>
        <div class="col-sm-6 col-md-3">
            <div class="card shadow-sm p-3 text-center">
                <small>Total Peceras</small>
                <h4>@Model.TotalPeceras</h4>
            </div>
        </div>
    </div>

    <!-- KPIs -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card shadow-sm p-3 text-center">
                <small>Pez más atendido</small>
                @if (Model.PecesConMasAtenciones?.Any() == true)
                {
                    var top = Model.PecesConMasAtenciones.First();
                    <h3>@top.NombrePez</h3>
                    <small>@top.CantidadAtenciones atenciones</small>
                }
                else
                {
                    <h3>—</h3>
                }
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm p-3 text-center">
                <small>Alimento más usado</small>
                <div id="alimentoTopPlaceholder">
                    <h3>—</h3>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm p-3 text-center">
                <small>Pecera con más peces</small>
                <div id="peceraTopPlaceholder">
                    <h3>—</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- GRAFICOS + TABLA -->
    <div class="row g-3">

        <!-- COLUMNA IZQUIERDA -->
        <div class="col-lg-7">

            <!-- Gráfico de líneas -->
            <div class="card shadow-sm p-3 mb-3">
                <h5>Atenciones últimos 6 meses</h5>
                <canvas id="graficoLineas" height="150"></canvas>
            </div>

            <!-- TABLA -->
            <div class="card shadow-sm p-3">
                <h5 class="mb-3">Últimas 5 atenciones</h5>
                <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Pez</th>
                                <th>Alimento</th>
                                <th>Usuario</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.UltimasAtenciones?.Any() == true)
                            {
                                foreach (var a in Model.UltimasAtenciones)
                                {
                                    <tr>
                                        <td>@a.Fecha.ToString("dd/MM/yyyy HH:mm")</td>
                                        <td>@a.IdPecesNavigation?.NombrePez</td>
                                        <td>@a.IdAlimentoNavigation?.NombreAlimento</td>
                                        <td>@a.IdUserNavigation?.Nombre</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr><td colspan="4">Sin datos disponibles.</td></tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>

        </div>

        <!-- COLUMNA DERECHA -->
        <div class="col-lg-5">

            <div class="card shadow-sm p-3 mb-3">
                <h5>Top 5 Peces (más atenciones)</h5>
                <canvas id="graficoBarras" height="150"></canvas>
            </div>

            <div class="card shadow-sm p-3">
                <h5>Alimentos usados (proporción)</h5>
                <canvas id="graficoDonut" height="180"></canvas>
            </div>

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const meses = @Html.Raw(JsonConvert.SerializeObject(Model.AtencionesPorMes.Select(x => x.Mes)));
    const cantidades = @Html.Raw(JsonConvert.SerializeObject(Model.AtencionesPorMes.Select(x => x.Cantidad)));
    const pecesNombres = @Html.Raw(JsonConvert.SerializeObject(Model.PecesConMasAtenciones.Select(p => p.NombrePez)));
    const pecesCant = @Html.Raw(JsonConvert.SerializeObject(Model.PecesConMasAtenciones.Select(p => p.CantidadAtenciones)));

    // Line chart
    new Chart(graficoLineas, {
        type: 'line',
        data: { labels: meses, datasets: [{ data: cantidades, tension: .25, borderWidth: 2, fill: true }] },
        options: { plugins: { legend: { display: false } } }
    });

    // Bar chart
    new Chart(graficoBarras, {
        type: 'bar',
        data: { labels: pecesNombres, datasets: [{ data: pecesCant, borderWidth: 1 }] },
        options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });

    // Donut + KPIs
    fetch('/Dashboard/ObtenerDatosGraficos')
    .then(r => r.json())
    .then(data => {

        /* ============================
           ALIMENTO MÁS USADO
        ============================ */
        if (data.alimentosMasUsados.length > 0) {
            const topAli = data.alimentosMasUsados[0];
            document.getElementById("alimentoTopPlaceholder").innerHTML = `
                <h3>${topAli.nombre}</h3>
                <small>${topAli.cantidad} usos</small>
            `;
        } else {
            document.getElementById("alimentoTopPlaceholder").innerHTML = `<h3>—</h3>`;
        }

        /* ============================
           PECERA CON MÁS PECES
        ============================ */
           if (data.pecesPorPecera.length > 0) {
        const topPecera = data.pecesPorPecera[0];
        document.getElementById("peceraTopPlaceholder").innerHTML = `
            <h3>${topPecera.pecera}</h3>
            <small>${topPecera.cantidad} peces</small>
        `;
    }


        /* ============================
           GRAFICO DONUT
        ============================ */
        new Chart(graficoDonut, {
            type: "doughnut",
            data: {
                labels: data.alimentosMasUsados.map(x => x.nombre),
                datasets: [{ data: data.alimentosMasUsados.map(x => x.cantidad) }]
            }
        });

    });
</script>
